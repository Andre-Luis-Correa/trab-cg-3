<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Mestre da Geometria</title>

    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script
        src="https://unpkg.com/aframe-environment-component@1.3.4/dist/aframe-environment-component.min.js"></script>
</head>

<body>
    <script>
        let pontuacao = 0;
        let rodada = 0;

        const desafios = [
            { pergunta: "O QUE PARECE UM(A) SORVETE?", resposta: "cone", imagem: "sorvete.png" },
            { pergunta: "O QUE PARECE UMA BOLA?", resposta: "esfera", imagem: "bola.png" },
            { pergunta: "O QUE PARECE UM DADO?", resposta: "cubo", imagem: "dado.png" }
        ];

        let desafioAtual = null;

        function tocarSom(id) {
            const a = document.querySelector(id);
            if (a) {
                a.currentTime = 0;
                a.play().catch(() => { });
            }
        }

        function vibrar(intensidade, duracao) {
            document.querySelectorAll('[laser-controls]').forEach(c => {
                const gp = c.components['tracked-controls']?.controller;
                if (gp?.hapticActuators?.length > 0) {
                    gp.hapticActuators[0].pulse(intensidade, duracao);
                }
            });
        }

        function atualizarPlacar() {
            document.querySelector('#textoPontos').setAttribute('value', 'SCORE: ' + pontuacao);
        }

        function mostrarFeedback(msg, cor) {
            const txt = document.querySelector('#textoFeedback');
            txt.setAttribute('value', msg);
            txt.setAttribute('color', cor || 'white');

            clearTimeout(window._feedbackTimer);
            window._feedbackTimer = setTimeout(() => txt.setAttribute('value', ''), 2000);
        }

        function iniciarNovoDesafio() {
            rodada++;

            let novo;
            do {
                novo = desafios[Math.floor(Math.random() * desafios.length)];
            } while (desafioAtual && novo.pergunta === desafioAtual.pergunta);

            desafioAtual = novo;

            document.querySelector("#textoPergunta").setAttribute("value", desafioAtual.pergunta);

            document.querySelector("#imagemPergunta")
                .setAttribute("material", "src", desafioAtual.imagem);


            mostrarFeedback("Escolha a forma correta!", "#00cfff");
        }

        AFRAME.registerComponent("quiz-click", {
            schema: {
                tipo: { type: "string" }
            },

            init() {
                this.el.classList.add("clickable");

                this.el.addEventListener("click", () => {
                    if (!desafioAtual) return;

                    if (this.data.tipo === desafioAtual.resposta) {
                        pontuacao += 10;
                        atualizarPlacar();
                        tocarSom("#som-acerto");
                        vibrar(0.9, 180);

                        mostrarFeedback("ACERTOU! +10", "#00FF00");

                        this.el.setAttribute("animation__acerto", {
                            property: "scale",
                            to: "0.35 0.35 0.35",
                            dur: 250,
                            easing: "easeOutQuad",
                            dir: "alternate",
                            loop: 2
                        });

                        setTimeout(() => {
                            iniciarNovoDesafio();
                        }, 700);

                    } else {
                        tocarSom("#som-erro");
                        vibrar(0.5, 120);

                        mostrarFeedback("ERRADO!", "#ff4444");

                        this.el.setAttribute("animation__erro", {
                            property: "rotation",
                            to: "0 20 0",
                            dur: 100,
                            dir: "alternate",
                            loop: 4
                        });
                    }
                });
            }
        });

        AFRAME.registerComponent('voltar-menu', {
            init() {
                this.el.addEventListener('click', () => window.location.href = 'index.html');
            }
        });

        window.addEventListener("load", () => {
            atualizarPlacar();
            iniciarNovoDesafio();
        });
    </script>

    <a-scene>

        <a-assets>
            <audio id="som-acerto" src="som_acerto.wav" preload="auto"></audio>
            <audio id="som-erro" src="som_erro.ogg" preload="auto"></audio>

            <img id="imgSorvete" src="sorvete.png">
            <img id="imgBola" src="bola.png">
            <img id="imgDado" src="dado.png">
        </a-assets>

        <a-entity environment="preset: forest; lighting: none"></a-entity>

        <a-light type="ambient" color="#ffffff" intensity="0.45"></a-light>
        <a-light type="directional" color="#ffffff" intensity="0.85" position="-2 6 3"></a-light>

        </a-plane>

        <a-entity id="rig" position="0 0 0">
            <a-camera position="0 1.6 0">
                <a-cursor raycaster="objects: .clickable" material="color: white; shader: flat">
                </a-cursor>
            </a-camera>

            <a-entity id="maoEsquerda" laser-controls="hand: left"
                raycaster="objects: .clickable; far: 10; showLine: true">
            </a-entity>

            <a-entity id="maoDireita" laser-controls="hand: right"
                raycaster="objects: .clickable; far: 10; showLine: true">
            </a-entity>
        </a-entity>

        <a-entity id="interfaceJogo">

            <a-entity position="0 5.0 -3.4">
                <a-plane width="8.0" height="1.2" color="#111" depth="0.1" opacity="0.9"></a-plane>

                <a-text value="MESTRE DA GEOMETRIA" position="0 0.3 0.02" align="center" width="6.5" color="#FFD700">
                </a-text>

                <a-text id="textoPontos" value="SCORE: 0" position="2.9 0 0.02" align="center" width="4"
                    color="#00FF00">
                </a-text>

                <a-box class="clickable" voltar-menu color="#c0392b" position="-2.9 0 0.02" width="1.4" height="0.4"
                    depth="0.1">
                    <a-text value="MENU" align="center" position="0 0 0.06" width="4" color="white">
                    </a-text>
                </a-box>
            </a-entity>

            <a-entity position="0 3.0 -3.4">
                <a-plane width="5.8" height="2.0" color="#000" opacity="0.65"></a-plane>

                <a-text id="textoPergunta" value="PERGUNTA" position="0 0.7 0.02" align="center" width="6"
                    color="#FFD700">
                </a-text>

                <a-plane id="imagemPergunta" position="0 0.0 0.02" width="1.1" height="1.0"
                    material="shader: flat; transparent: true; src: #imgSorvete">
                </a-plane>

                <a-text value="Clique na forma correta!" position="0 -0.7 0.02" align="center" width="5"
                    color="#00cfff">
                </a-text>
            </a-entity>

            <a-text id="textoFeedback" value="" position="0 1.55 -2.8" align="center" width="6" color="white">
            </a-text>

            <a-entity position="-5.0 1.4 -3.0" rotation="0 25 0">
                <a-plane width="1.6" height="1.1" color="#111" opacity="0.8"></a-plane>

                <a-text value="CONTROLES\n\nAPONTE O LASER\nE CLIQUE!" position="0 0 0.02" align="center" width="3"
                    color="white" line-height="55">
                </a-text>
            </a-entity>

        </a-entity>

        <a-entity position="0 0 -2">
            <a-box position="0 0.85 0" width="3.4" height="0.15" depth="1.8" color="#7d4e24"></a-box>

            <a-box position="-1.6 0.4 0.8" width="0.12" height="0.8" depth="0.12" color="#5d3a1a"></a-box>
            <a-box position="1.6 0.4 0.8" width="0.12" height="0.8" depth="0.12" color="#5d3a1a"></a-box>
            <a-box position="-1.6 0.4 -0.8" width="0.12" height="0.8" depth="0.12" color="#5d3a1a"></a-box>
            <a-box position="1.6 0.4 -0.8" width="0.12" height="0.8" depth="0.12" color="#5d3a1a"></a-box>
        </a-entity>

        <a-box id="formaBox" class="clickable" quiz-click="tipo: cubo" position="-0.9 1.2 -2" scale="0.25 0.25 0.25"
            color="#e67e22">
        </a-box>
        <a-text value="CUBO" position="-0.9 1.45 -2" align="center" width="3" color="black"></a-text>

        <a-sphere id="formaSphere" class="clickable" quiz-click="tipo: esfera" position="0 1.2 -2" radius="0.15"
            color="#9b59b6">
        </a-sphere>
        <a-text value="ESFERA" position="0 1.45 -2" align="center" width="3" color="black"></a-text>

        <a-cone id="formaCone" class="clickable" quiz-click="tipo: cone" position="0.9 1.2 -2" radius-bottom="0.14"
            height="0.3" color="#2ecc71">
        </a-cone>
        <a-text value="CONE" position="0.9 1.45 -2" align="center" width="3" color="black"></a-text>

    </a-scene>

</body>

</html>